local a=require("Vector")local b=require("OpenComputersGL/Materials")local c=require("Screen")local d={depthBuffer={},viewport={}}function d.clearDepthBuffer()for e=1,d.viewport.height do d.depthBuffer[e]={}for f=1,d.viewport.width do d.depthBuffer[e][f]=math.huge end end end;function d.setViewport(g,h,i,j,k,l,m)d.viewport.x1=g;d.viewport.y1=h;d.viewport.x2=i;d.viewport.y2=j;d.viewport.nearClippingSurface=k;d.viewport.farClippingSurface=l;d.viewport.projectionSurface=m;d.viewport.width=i-g+1;d.viewport.height=j-h+1;d.viewport.xCenter=math.floor(g+d.viewport.width/2)d.viewport.yCenter=math.floor(h+d.viewport.height/2)end;function d.setPixelUsingDepthBuffer(f,e,n,o)if d.isVertexInViewRange(f,e,n)then if n<d.depthBuffer[e][f]then d.depthBuffer[e][f]=n;c.semiPixelRawSet(c.getIndex(f,math.ceil(e/2)),o,e%2==0)end end end;function d.isVertexInViewRange(f,e,p)return f>=d.viewport.x1 and f<=d.viewport.x2 and e>=d.viewport.y1 and e<=d.viewport.y2 and p>=d.viewport.nearClippingSurface and p<=d.viewport.farClippingSurface end;function d.visualizeDepthBuffer()local q,r=math.huge,-math.huge;for e=1,#d.depthBuffer do for f=1,#d.depthBuffer[e]do if d.depthBuffer[e][f]~=math.huge then q,r=math.min(q,d.depthBuffer[e][f]),math.max(r,d.depthBuffer[e][f])end end end;local s=math.abs(r-q)local t={[0]=0xFFFFFF,[1]=0xEEEEEE,[2]=0xDDDDDD,[3]=0xCCCCCC,[4]=0xBBBBBB,[5]=0xAAAAAA,[6]=0x999999,[7]=0x888888,[8]=0x777777,[9]=0x666666,[10]=0x555555,[11]=0x444444,[12]=0x333333,[13]=0x222222,[14]=0x111111,[15]=0x000000}for e=1,#d.depthBuffer do for f=1,#d.depthBuffer[e]do local u=(d.depthBuffer[e][f]-math.abs(q))/s;local v=t[math.floor(#t*u)]c.semiPixelSet(f,e,v or 0x0)end end end;function d.renderLine(g,h,w,i,j,x,v)local y,z,A,B,C,D,E=g,i,h,j,false,math.abs(i-g),math.abs(j-h)if D<E then y,z,A,B,C,D,E=h,j,g,i,true,E,D end;if A>B then A,B=B,A;y,z=z,y;w,x=x,w end;local F,G,H=A,1,D/E;local I=H;local p,J=w,(x-w)/D;for K=y,z,y<z and 1 or-1 do if C then d.setPixelUsingDepthBuffer(F,K,p,v)else d.setPixelUsingDepthBuffer(K,F,p,v)end;G,p=G+1,p+J;if G>I then F,I=F+1,I+H end end end;function d.renderDot(f,e,p,v)d.setPixelUsingDepthBuffer(f,e,p,v)end;local function L(M)local N,O,P=1,1,1;for Q=1,3 do M[Q][2]=math.floor(M[Q][2])if M[Q][2]<M[N][2]then N=Q end;if M[Q][2]>M[P][2]then P=Q end end;for Q=1,3 do if Q~=N and Q~=P then O=Q end end;local R=M[O][2]-M[N][2]local S=M[P][2]-M[N][2]local T,U=M[N][1],M[N][1]local V=(M[O][1]-M[N][1])/R;local W=(M[P][1]-M[N][1])/S;local X,Y=M[N][3],M[N][3]local Z=(M[O][3]-M[N][3])/R;local _=(M[P][3]-M[N][3])/S;return N,O,P,T,U,V,W,X,Y,Z,_ end;local function a0(M,O,P)local a1=M[P][2]-M[O][2]return M[O][1],(M[P][1]-M[O][1])/a1,M[O][3],(M[P][3]-M[O][3])/a1 end;local function a2(T,U,X,Y,e,v)if U<T then T,U,X,Y=U,T,Y,X end;local p,J=X,(Y-X)/(U-T)for f=math.floor(T),math.floor(U)do d.setPixelUsingDepthBuffer(f,e,p,v)p=p+J end end;function d.renderFilledTriangle(M,v)local N,O,P,T,U,V,W,X,Y,Z,_=L(M)for e=M[N][2],M[O][2]-1 do a2(T,U,X,Y,e,v)T,U,X,Y=T+V,U+W,X+Z,Y+_ end;T,V,X,Z=a0(M,O,P)for e=M[O][2],M[P][2]do a2(T,U,X,Y,e,v)T,U,X,Y=T+V,U+W,X+Z,Y+_ end end;local function a3(a4,a5,T,U,X,Y,a6,a7,a8,a9,e,aa)if U<T then T,U,X,Y=U,T,Y,X;a6,a7=a7,a6;a8,a9=a9,a8 end;local p,J=X,(Y-X)/(U-T)a7=a6+(a7-a6)*a5/p;a9=a8+(a9-a8)*a5/p;local ab,ac=a6,(a7-a6)/(U-T)local ad,ae=a8,(a9-a8)/(U-T)local v,af,ag;for f=math.floor(T),math.floor(U)do af,ag=math.floor(ab+0.5),math.floor(ad+0.5)if aa[ag]and aa[ag][af]then v=aa[ag][af]else v=0x00FF00 end;d.setPixelUsingDepthBuffer(f,e,p,v)p,ab,ad=p+J,ab+ac,ad+ae end end;function d.renderTexturedTriangle(M,aa)local N,O,P,T,U,V,W,X,Y,Z,_=L(M)local a6,a7=M[N][4],M[N][4]local ah=(M[O][4]-M[N][4])/(M[O][2]-M[N][2])local ai=(M[P][4]-M[N][4])/(M[P][2]-M[N][2])local a8,a9=M[N][5],M[N][5]local aj=(M[O][5]-M[N][5])/(M[O][2]-M[N][2])local ak=(M[P][5]-M[N][5])/(M[P][2]-M[N][2])for e=M[N][2],M[O][2]-1 do a3(M[N][3],M[P][3],T,U,X,Y,a6,a7,a8,a9,e,aa)T,U,X,Y=T+V,U+W,X+Z,Y+_;a6,a7,a8,a9=a6+ah,a7+ai,a8+aj,a9+ak end;T,V,X,Z=a0(M,O,P)a6,ah=M[O][4],(M[P][4]-M[O][4])/(M[P][2]-M[O][2])a8,aj=M[O][5],(M[P][5]-M[O][5])/(M[P][2]-M[O][2])for e=M[O][2],M[P][2]do a3(M[N][3],M[P][3],T,U,X,Y,a6,a7,a8,a9,e,aa)T,U,X,Y=T+V,U+W,X+Z,Y+_;a6,a7,a8,a9=a6+ah,a7+ai,a8+aj,a9+ak end end;function d.renderFloatingText(f,e,p,v,al)local am=unicode.len(al)f,e=math.floor(f-am/2),math.floor(e)local an,ao=math.modf(e/2)local ap,aq;for Q=1,am do if d.isVertexInViewRange(f,e,p)then if p<d.depthBuffer[e][f]then if ao==0 then d.depthBuffer[e-1][f]=p;d.depthBuffer[e][f]=p else d.depthBuffer[e][f]=p;if d.depthBuffer[e+1]then d.depthBuffer[e+1][f]=p end end;ap=c.getIndex(f,an)aq=c.rawGet(ap)c.rawSet(ap,aq,v,unicode.sub(al,Q,Q))end end;f=f+1 end end;local function ar(f,e,as,v)for Q=1,#as do if as[Q]==1 then c.drawSemiPixelRectangle(f,e,3,1,v)elseif as[Q]==2 then c.drawSemiPixelRectangle(f+2,e,1,3,v)elseif as[Q]==3 then c.drawSemiPixelRectangle(f+2,e+2,1,3,v)elseif as[Q]==4 then c.drawSemiPixelRectangle(f,e+4,3,1,v)elseif as[Q]==5 then c.drawSemiPixelRectangle(f,e+2,1,3,v)elseif as[Q]==6 then c.drawSemiPixelRectangle(f,e,1,3,v)elseif as[Q]==7 then c.drawSemiPixelRectangle(f,e+2,3,1,v)else error("Че за говно ты сюда напихал? Переделывай!")end end end;function d.renderFPSCounter(f,e,at,v)local au={["0"]={1,2,3,4,5,6},["1"]={2,3},["2"]={1,2,4,5,7},["3"]={1,2,3,4,7},["4"]={2,3,6,7},["5"]={1,3,4,6,7},["6"]={1,3,4,5,6,7},["7"]={1,2,3},["8"]={1,2,3,4,5,6,7},["9"]={1,2,3,4,6,7}}for Q=1,#at do ar(f,e,au[at:sub(Q,Q)],v)f=f+4 end end;return d
