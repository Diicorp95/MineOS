local a=require("Event")local b=require("Screen")local c=require("Vector")local d=require("OpenComputersGL/Main")local e=require("OpenComputersGL/Renderer")local f=require("OpenComputersGL/Materials")local g={}function g.newPivotPoint(h)return{position=h,axis={c.newVector3(1,0,0),c.newVector3(0,1,0),c.newVector3(0,0,1)}}end;function g.newLight(h,i,j)return{position=h,emissionDistance=j,intensity=i}end;local function k(l)local m,n,o;for p=1,#l.triangles do m,n,o=l.vertices[l.triangles[p][1]],l.vertices[l.triangles[p][2]],l.vertices[l.triangles[p][3]]d.pushTriangleToRenderQueue(c.newVector5(m[1],m[2],m[3],m[4],m[5]),c.newVector5(n[1],n[2],n[3],n[4],n[5]),c.newVector5(o[1],o[2],o[3],o[4],o[5]),l.triangles[p][4]or l.material)end end;function g.newMesh(h,q,r,s)local l={}l.vertices=q;l.position=h;for t=1,#l.vertices do l.vertices[t][1],l.vertices[t][2],l.vertices[t][3]=l.vertices[t][1]+h[1],l.vertices[t][2]+h[2],l.vertices[t][3]+h[3]end;l.triangles=r;l.material=s;l.pushToRenderQueue=k;return l end;local function u(v)d.pushLineToRenderQueue(c.newVector3(v.vertices[1][1],v.vertices[1][2],v.vertices[1][3]),c.newVector3(v.vertices[2][1],v.vertices[2][2],v.vertices[2][3]),v.color)end;function g.newLine(h,m,n,w)return{vertices={m,n},color=w,pushToRenderQueue=u}end;local function x(y)d.pushFloatingTextToRenderQueue(c.newVector3(y.position[1],y.position[2],y.position[3]),y.text,y.color)end;function g.newFloatingText(h,w,z)return{position=h,color=w,text=z,pushToRenderQueue=x}end;function g.newPlane(h,A,B,C,D,s)local q,r,E,F,t={},{},A/C,B/D,1;C,D=C+1,D+1;for G=1,D do for H=1,C do table.insert(q,c.newVector3(H*E-E,0,G*F-F))if H<C and G<D then table.insert(r,d.newIndexedTriangle(t,t+1,t+C))table.insert(r,d.newIndexedTriangle(t+1,t+C+1,t+C))end;t=t+1 end end;return g.newMesh(h,q,r,s)end;function g.newTexturedPlane(h,A,B,I)A,B=A/2,B/2;return g.newMesh(h,{c.newVector5(-A,0,-B,1,I.height),c.newVector5(-A,0,B,1,1),c.newVector5(A,0,B,I.width,1),c.newVector5(A,0,-B,I.width,I.height)},{d.newIndexedTriangle(1,2,3),d.newIndexedTriangle(1,4,3)},f.newTexturedMaterial(I))end;function g.newCube(h,J,s)local K=J/2;return g.newMesh(h,{c.newVector3(-K,-K,-K),c.newVector3(-K,K,-K),c.newVector3(K,K,-K),c.newVector3(K,-K,-K),c.newVector3(K,-K,K),c.newVector3(K,K,K),c.newVector3(-K,K,K),c.newVector3(-K,-K,K)},{d.newIndexedTriangle(1,2,3),d.newIndexedTriangle(1,4,3),d.newIndexedTriangle(4,3,6),d.newIndexedTriangle(4,5,6),d.newIndexedTriangle(5,6,7),d.newIndexedTriangle(5,8,7),d.newIndexedTriangle(8,7,2),d.newIndexedTriangle(8,1,2),d.newIndexedTriangle(2,7,6),d.newIndexedTriangle(2,3,6),d.newIndexedTriangle(1,8,5),d.newIndexedTriangle(1,4,5)},s)end;local function L(M,N,O,P)M.rotation[1],M.rotation[2],M.rotation[3]=N,O,P;return M end;local function Q(M,R,S,T)L(M,M.rotation[1]+R,M.rotation[2]+S,M.rotation[3]+T)return M end;local function U(M,V,W,X)local Y,Z,_=V-M.position[1],W-M.position[2],X-M.position[3]local a0=math.rad(180)local a1=math.atan(Y/_)if _<0 then a1=a1+a0 end;local a2=math.atan(math.sqrt(Y^2+_^2)/Z)-math.rad(90)if Z<0 then a2=a2+a0 end;L(M,a2,a1,0)end;local function a3(M,a4,a5,a6)M.position[1],M.position[2],M.position[3]=a4,a5,a6;return M end;local function a7(M,a8,a9,aa,ab,ac,ad)a3(M,M.position[1]+a8,M.position[2]+a9,M.position[3]+aa)return M end;local function ae(M,af)if af>0 and af<math.pi then M.FOV=af;M.projectionSurface=M.farClippingSurface-M.FOV/math.rad(180)*(M.farClippingSurface-M.nearClippingSurface)else error("FOV can't be < 0 or > 180 degrees")end;return M end;function g.newCamera(h,af,ag,ah)local M={}M.projectionEnabled=true;M.position=h;M.rotation={}M.nearClippingSurface=ag;M.farClippingSurface=ah;M.FOV=af;M.setPosition=a3;M.translate=a7;M.rotate=Q;M.setRotation=L;M.setFOV=ae;M.lookAt=U;L(M,0,0,0)ae(M,M.FOV)return M end;local function ai(aj,ak)table.insert(aj.objects,ak)return ak end;local function al(aj,am)table.insert(aj.lights,am)return am end;local function an(aj,ao)for ap=1,#ao do table.insert(aj.objects,ao[ap])end;return ao end;local function aq(aj)e.setViewport(1,1,b.getWidth(),b.getHeight()*2,aj.camera.nearClippingSurface,aj.camera.farClippingSurface,aj.camera.projectionSurface)d.clearBuffer(aj.backgroundColor)d.renderMode=aj.renderMode;d.auxiliaryMode=aj.auxiliaryMode;for ap=1,#aj.objects do aj.objects[ap]:pushToRenderQueue()end;for ar=1,#aj.lights do d.pushLightToRenderQueue(c.newVector3(aj.lights[ar].position[1],aj.lights[ar].position[2],aj.lights[ar].position[3]),aj.lights[ar].intensity,aj.lights[ar].emissionDistance)end;d.translate(-aj.camera.position[1],-aj.camera.position[2],-aj.camera.position[3])d.rotate(d.rotateVectorRelativeToYAxis,-aj.camera.rotation[2])d.rotate(d.rotateVectorRelativeToXAxis,-aj.camera.rotation[1])if aj.renderMode==d.renderModes.flatShading then d.calculateLights()end;if aj.camera.projectionEnabled then d.createPerspectiveProjection()end;d.render()return aj end;function g.newScene(as)local aj={}aj.renderMode=d.renderModes.constantShading;aj.auxiliaryMode=d.auxiliaryModes.disabled;aj.backgroundColor=as;aj.objects={}aj.lights={}aj.addObject=ai;aj.addLight=al;aj.addObjects=an;aj.render=aq;aj.camera=g.newCamera(c.newVector3(0,0,0),math.rad(90),1,100)return aj end;local function at(au,av)return c.newVector3(au[2]*av[3]-au[3]*av[2],au[3]*av[1]-au[1]*av[3],au[1]*av[2]-au[2]*av[1])end;local function aw(au)return math.sqrt(au[1]^2+au[2]^2+au[3]^2)end;function g.meshRaycast(l,ax,ay)local az,aA;for p=1,#l.triangles do local aB,aC,aD=l.vertices[l.triangles[p][1]],l.vertices[l.triangles[p][2]],l.vertices[l.triangles[p][3]]local aE=at(c.newVector3(aD[1]-aB[1],aD[2]-aB[2],aD[3]-aB[3]),c.newVector3(aC[1]-aB[1],aC[2]-aB[2],aC[3]-aB[3]))local aF=-aE[1]*aB[1]-aE[2]*aB[2]-aE[3]*aB[3]local aG=aF+aE[1]*ax[1]+aE[2]*ax[2]+aE[3]*ax[3]local aH=aE[1]*ax[1]-aE[1]*ay[1]+aE[2]*ax[2]-aE[2]*ay[2]+aE[3]*ax[3]-aE[3]*ay[3]if aH~=0 then local aI=aG/aH;if aI>=0 and aI<=1 and(not az or aI<az)then local aJ=c.newVector3(ax[1]+(ay[1]-ax[1])*aI,ax[2]+(ay[2]-ax[2])*aI,ax[3]+(ay[3]-ax[3])*aI)local aK=c.newVector3(aB[1]-aJ[1],aB[2]-aJ[2],aB[3]-aJ[3])local aL=c.newVector3(aC[1]-aJ[1],aC[2]-aJ[2],aC[3]-aJ[3])local aM=c.newVector3(aD[1]-aJ[1],aD[2]-aJ[2],aD[3]-aJ[3])local aN=aw(at(aK,aL))+aw(at(aL,aM))+aw(at(aM,aK))local aO=aw(aE)if math.abs(aN-aO)<1 then aA=p;az=aI end end end end;return aA,az end;function g.sceneRaycast(aj,ax,ay)local aP,aA,az;for ap=1,#aj.objects do if aj.objects[ap].triangles then local p,aI=g.meshRaycast(aj.objects[ap],ax,ay)if p and(not az or aI<az)then aP,aA,az=ap,p,aI end end end;return aP,aA,az end;function g.newPolyCatMesh(h,J)return g.newMesh(h,{c.newVector3(-1.0*J,0.8*J,0.3*J),c.newVector3(-0.5*J,0.5*J,0.3*J),c.newVector3(0.0*J,0.5*J,0.3*J),c.newVector3(0.5*J,0.5*J,0.3*J),c.newVector3(1.0*J,0.8*J,0.3*J),c.newVector3(0.8*J,0.2*J,0.3*J),c.newVector3(0.7*J,-0.3*J,0.3*J),c.newVector3(0.0*J,-0.8*J,0.3*J),c.newVector3(-0.7*J,-0.3*J,0.3*J),c.newVector3(-0.8*J,0.2*J,0.3*J),c.newVector3(-0.2*J,-0.1*J,0.0*J),c.newVector3(0.2*J,-0.1*J,0.0*J),c.newVector3(0.0*J,-0.3*J,0.0*J)},{d.newIndexedTriangle(1,2,10,f.newSolidMaterial(0x555555)),d.newIndexedTriangle(2,11,10,f.newSolidMaterial(0x6fe7fc)),d.newIndexedTriangle(2,3,11,f.newSolidMaterial(0xDDDDDD)),d.newIndexedTriangle(3,12,11,f.newSolidMaterial(0xDDDDDD)),d.newIndexedTriangle(3,4,12,f.newSolidMaterial(0xDDDDDD)),d.newIndexedTriangle(4,6,12,f.newSolidMaterial(0xa8f1fd)),d.newIndexedTriangle(4,5,6,f.newSolidMaterial(0x808080)),d.newIndexedTriangle(6,7,8,f.newSolidMaterial(0xCCCCCC)),d.newIndexedTriangle(12,6,8,f.newSolidMaterial(0xCCCCCC)),d.newIndexedTriangle(13,12,8,f.newSolidMaterial(0xCCCCCC)),d.newIndexedTriangle(11,12,13,f.newSolidMaterial(0x555555)),d.newIndexedTriangle(11,13,8,f.newSolidMaterial(0xBBBBBB)),d.newIndexedTriangle(10,11,8,f.newSolidMaterial(0xBBBBBB)),d.newIndexedTriangle(10,8,9,f.newSolidMaterial(0xBBBBBB))},f.newSolidMaterial(0xFF0000))end;function g.intro(h,J)local aQ=require("GUI")local aj=g.newScene(0xEEEEEE)aj:addObject(g.newPolyCatMesh(h,J))aj:addObject(g.newFloatingText(c.newVector3(h[1]+2,h[2]-J,h[3]+J*0.1),0xBBBBBB,"Powered by MeowEngineâ„¢"))local aR,aS,aT=-30,20,4;local aU,aV=0,1/math.abs(aS-aR)*aT;aj.camera:setPosition(aR,0,-32)while aj.camera.position[1]<aS do aj.camera:translate(aT,0,0)aj.camera:lookAt(0,0,0)aj:render()if aj.camera.position[1]<aS then b.clear(0x0,aU)end;b.update()aU=aU+aV;a.sleep(0.01)end;a.sleep(2)for aW=1,0,-0.2 do aj:render()b.clear(0x0,aW)b.update()end end;return g
